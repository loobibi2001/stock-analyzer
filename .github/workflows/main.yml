# .github/workflows/main.yml
# 這個檔案告訴 GitHub Actions 機器人該如何自動執行我們的任務

name: Daily Stock Analysis

# 觸發條件：設定排程
on:
  workflow_dispatch: # 允許手動觸發
  schedule:
    # 使用 UTC 時間，'0 8 * * 1-5' 代表台灣時間 (UTC+8) 下午 4 點，且只在週一到週五執行
    - cron: '0 8 * * 1-5'

jobs:
  build:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu 虛擬環境來執行

    steps:
    # 步驟 1: 取得你 repository 的最新程式碼
    - name: Checkout repository
      uses: actions/checkout@v3

    # 步驟 1.5: 安裝必要的系統編譯套件
    # 這是解決 ta-lib 編譯問題的關鍵，確保有 build-essential (包含 gcc 和 g++) 和 Python 開發套件
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev

    # 2: 設定 Python 環境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9' # 指定 Python 版本

    # 步驟 3.1: 手動下載、編譯並安裝 TA-Lib 底層函式庫
    - name: Install TA-Lib from source
      run: |
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        make
        sudo make install
        sudo ldconfig # 更新動態連結器快取，確保系統能找到新安裝的函式庫

    # 步驟 3.2: 安裝 Python 所需的套件
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # 確保 LD_LIBRARY_PATH 包含 ta-lib 的安裝路徑，幫助 pip 找到函式庫
        # 這一步是解決 "g++: fatal error: No such file or directory" 的關鍵
        export LD_LIBRARY_PATH="/usr/lib:$LD_LIBRARY_PATH"
        pip install TA-Lib pandas requests
        # 原來的 TA_LIBRARY_PATH=/usr/lib 在此通常就不需要了，
        # 因為系統級別的 ldconfig 會讓 Python 的 ta-lib 找到它

    # 步驟 4: 執行我們的 V25 Python 掃描腳本
    - name: Run stock analyzer
      env:
        # 將我們存在 GitHub Secrets 的 Token 傳遞給 Python 腳本
        API_TOKEN: ${{ secrets.FINMIND_API_TOKEN }}
      run: python V25_scanner_final.py # 使用最新的腳本檔名

    # 步驟 5: 將腳本產生變動的檔案 (index.html) 認可並推送回 repository
    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        # 只 add index.html 和 state 檔案，避免 add 其他不應被追蹤的檔案
        git add index.html portfolio_state.json
        # 如果有變動，才執行 commit
        git diff --staged --quiet || git commit -m "每日自動更新交易計畫"
        git push
