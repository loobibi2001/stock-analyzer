# å·¥ä½œæµç¨‹çš„åç¨±
name: Daily Stock Analysis

# è§¸ç™¼æ¢ä»¶
on:
  # 1. å®šæ™‚æ’ç¨‹
  schedule:
    # åœ¨ UTC æ™‚é–“ 09:00 (ç­‰æ–¼å°ç£/é¦™æ¸¯/åŒ—äº¬æ™‚é–“ä¸‹åˆ 5:00)ï¼Œæ¯é€±ä¸€åˆ°é€±äº”åŸ·è¡Œ
    - cron: '0 9 * * 1-5'
  # 2. å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# è¦åŸ·è¡Œçš„å·¥ä½œ
jobs:
  build-and-run:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è™›æ“¬æ©Ÿä¾†åŸ·è¡Œ
    runs-on: ubuntu-latest

    # å·¥ä½œä¸­çš„æ­¥é©Ÿ
    steps:
      # æ­¥é©Ÿ 1: ä¸‹è¼‰æ‚¨çš„ç¨‹å¼ç¢¼åˆ°è™›æ“¬æ©Ÿ
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # æ­¥é©Ÿ 3: å®‰è£æ‰€æœ‰å¿…è¦çš„ Python å¥—ä»¶
      - name: Install dependencies
        run: pip install -r requirements.txt

      # æ­¥é©Ÿ 4: å‹•æ…‹ä¿®æ”¹ Python è…³æœ¬ä»¥é©æ‡‰é›²ç«¯ç’°å¢ƒ
      - name: Modify Scripts for Actions Environment
        run: |
          # å°‡ update_stocks_daily.py ä¸­çš„ API Token æ”¹ç‚ºå¾ç’°å¢ƒè®Šæ•¸è®€å–
          sed -i "s|finmind_api_token = \".*\"|finmind_api_token = os.environ.get('FINMIND_API_TOKEN')|" update_stocks_daily.py
          # ç¢ºä¿ update_stocks_daily.py çš„é–‹é ­æœ‰ import os
          sed -i '1s/^/import os\n/' update_stocks_daily.py
          
          # å°‡æ‰€æœ‰è…³æœ¬ä¸­å¯«æ­»çš„ D:\ è·¯å¾‘æ”¹ç‚ºç›¸å°è·¯å¾‘ '.'
          sed -i "s|base_path = r\".*\"|base_path = '.'|" convert_csv_to_parquet.py
          sed -i "s|base_dir = r\".*\"|base_dir = '.'|" "daily_traderå°ç¥åè™Ÿï¼šæ··æ²Œç¥ç‹ï¼æ¥µé€Ÿçµ‚ç„‰.py"

      # æ­¥é©Ÿ 5: åŸ·è¡Œè³‡æ–™æ›´æ–°è…³æœ¬ (ä¸¦æ³¨å…¥ API Token)
      - name: Run Data Update
        run: python update_stocks_daily.py
        env:
          FINMIND_API_TOKEN: ${{ secrets.FINMIND_API_TOKEN }}

      # æ­¥é©Ÿ 6: åŸ·è¡Œ CSV è½‰ Parquet è…³æœ¬
      - name: Run CSV to Parquet Conversion
        run: python convert_csv_to_parquet.py

      # æ­¥é©Ÿ 7: åŸ·è¡Œä¸»åˆ†æè…³æœ¬
      - name: Run Main Analysis
        run: python "daily_traderå°ç¥åè™Ÿï¼šæ··æ²Œç¥ç‹ï¼æ¥µé€Ÿçµ‚ç„‰.py"

      # æ­¥é©Ÿ 8: å°‡è®Šæ›´çš„æª”æ¡ˆ (portfolio.json ç­‰) commit ä¸¦ push å›å€‰åº«
      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´ï¼Œå¦‚æœæ²’æœ‰å°±ä¸åŸ·è¡Œ commitï¼Œé¿å…å‡ºéŒ¯
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“ˆ Daily analysis report"
            git push
          fi
